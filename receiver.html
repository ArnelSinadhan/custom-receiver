<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Takokase HLS.js Receiver</title>
    <style>
      body,
      html {
        margin: 0;
        padding: 0;
        width: 100%;
        height: 100%;
        background: #000;
        font-family: Arial, sans-serif;
      }
      #video-container {
        position: relative;
        width: 100%;
        height: 100%;
      }
      video {
        width: 100%;
        height: 100%;
        background: black;
      }
      #debug {
        position: absolute;
        top: 10px;
        right: 10px;
        background: rgba(0, 0, 0, 0.85);
        color: #0f0;
        padding: 10px;
        font-family: monospace;
        font-size: 12px;
        max-width: 400px;
        max-height: 90vh;
        overflow-y: auto;
        border: 2px solid #0f0;
        z-index: 1000;
      }
      .log-entry {
        margin: 5px 0;
      }
      .log-entry.error {
        color: #f00;
      }
      .log-entry.warning {
        color: #ffa500;
      }
      .log-entry.success {
        color: #0f0;
      }
    </style>
  </head>
  <body>
    <div id="video-container">
      <video id="video" controls autoplay></video>
      <div id="debug"></div>
    </div>

    <!-- HLS.js -->
    <script src="https://cdn.jsdelivr.net/npm/hls.js@latest"></script>

    <!-- Chromecast Receiver SDK -->
    <script src="//www.gstatic.com/cast/sdk/libs/caf_receiver/v3/cast_receiver_framework.js"></script>

    <script>
      const DEBUG = true;
      const LOG_LIMIT = 50;
      const logContainer = document.getElementById("debug");
      let logs = [];

      function addLog(msg, type = "info") {
        const entry = document.createElement("div");
        entry.className = "log-entry " + type;
        entry.textContent = `[${new Date().toLocaleTimeString()}] ${msg}`;
        logContainer.prepend(entry);
        logs.unshift(entry);
        if (logs.length > LOG_LIMIT) {
          logs.pop().remove();
        }
        if (DEBUG) console.log(msg);
      }

      const video = document.getElementById("video");

      // =================================
      // Initialize HLS.js
      // =================================
      function initHLS(url, keyUrl = null) {
        if (Hls.isSupported()) {
          const hlsConfig = {
            xhrSetup: function (xhr, url) {
              // Optional: add custom headers
            },
          };
          const hls = new Hls(hlsConfig);

          if (keyUrl) {
            addLog("ðŸ” AES-128 key detected, using custom key URL", "success");
          }

          hls.loadSource(url);

          hls.on(Hls.Events.MANIFEST_PARSED, function (event, data) {
            addLog(
              `âœ… HLS Manifest loaded, ${data.levels.length} quality levels`
            );
            video.play();
          });

          hls.on(Hls.Events.LEVEL_SWITCHED, function (event, data) {
            addLog(`ðŸ“¶ Switched to level: ${data.level}`);
          });

          hls.on(Hls.Events.FRAG_LOADED, function (event, data) {
            addLog(`ðŸ“¦ Segment loaded: ${data.frag.url}`);
          });

          hls.on(Hls.Events.ERROR, function (event, data) {
            if (data.fatal) {
              addLog(
                `âŒ Fatal HLS.js error: ${data.type} - ${data.details}`,
                "error"
              );
            } else {
              addLog(
                `âš ï¸ HLS.js warning: ${data.type} - ${data.details}`,
                "warning"
              );
            }
          });

          // Audio & subtitle tracks
          hls.on(Hls.Events.AUDIO_TRACKS_UPDATED, function (event, data) {
            addLog(`ðŸŽµ Audio tracks: ${data.audioTracks.length}`);
            data.audioTracks.forEach((t, i) => {
              addLog(`  Track ${i}: ${t.name} (${t.lang})`);
            });
          });

          hls.on(Hls.Events.SUBTITLE_TRACKS_UPDATED, function (event, data) {
            addLog(`ðŸ“ Subtitle tracks: ${data.subtitleTracks.length}`);
            data.subtitleTracks.forEach((t, i) => {
              addLog(`  Subtitle ${i}: ${t.name} (${t.lang})`);
            });
          });

          hls.attachMedia(video);
        } else if (video.canPlayType("application/vnd.apple.mpegurl")) {
          addLog("âš ï¸ Native HLS playback");
          video.src = url;
          video.addEventListener("loadedmetadata", () => {
            video.play();
          });
        } else {
          addLog("âŒ HLS not supported on this device", "error");
        }
      }

      // =================================
      // Chromecast Receiver Setup
      // =================================
      const context = cast.framework.CastReceiverContext.getInstance();
      const playerManager = context.getPlayerManager();

      playerManager.setMessageInterceptor(
        cast.framework.messages.MessageType.LOAD,
        (loadRequest) => {
          addLog("ðŸ“¨ LOAD intercepted");
          const url = loadRequest.media.contentId;
          const keyUrl = loadRequest.media.customData?.keyUrl || null;

          addLog(`ðŸ“¡ Media URL: ${url}`);
          if (keyUrl) addLog(`ðŸ”‘ Key URL: ${keyUrl}`, "success");

          initHLS(url, keyUrl);
          return loadRequest;
        }
      );

      context.start({ disableIdleTimeout: false });
      addLog("ðŸš€ Chromecast HLS.js Receiver started", "success");
    </script>
  </body>
</html>
